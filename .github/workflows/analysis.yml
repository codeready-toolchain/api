name: Code Analysis CRDA
on:
  push:
    branches:
      - master
      - add-sonar
    tags-ignore:
      - '*.*'
jobs:
  crdascan:
    name: CRDA
    runs-on: ubuntu-latest
    permissions:
      # required for all workflows
      security-events: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Install Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.19.x
      - name: Install CRDA
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          source: github
          crda: latest
      - name: CRDA Scan
        id: crda_scan
        uses: redhat-actions/crda@v1
        with:
          crda_key: ${{ secrets.CRDA_KEY }}
          upload_sarif: false
      - name: Print Report Link
        run: echo ${{ steps.crda_scan.outputs.report_link }}
      - name: Print Sarif Report
        run: echo ${{ steps.crda_scan.outputs.crda_report_sarif }}
      - name: Upload result to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: ${{ steps.crda_scan.outputs.crda_report_sarif }}